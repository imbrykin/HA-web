---
- name: Deploy nginx on Docker Swarm with a custom webpage
  hosts: docker_swarm_manager,docker_swarm_workers
  become: yes
  tasks:
    - name: Pull nginx image
      command: docker pull nginx:latest

    - name: Get local IP
      shell: ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}'
      register: local_ip
      changed_when: false

    - name: Create nginx directory in /etc/nginx.files (if necessary)
      file:
        path: /etc/nginx.files
        state: directory
        mode: '0755'

    - name: Create custom index.html with local IP from the template
      template:
        src: '/HA-web/ansible-playbooks/templates/nginx.files/index.html.j2'
        dest: "/etc/nginx.files/index.html"
        mode: '0644'

    - name: Copy CSS file from the repository to the nginx directory
      copy:
        src: '/HA-web/ansible-playbooks/templates/nginx.files/styles.css'
        dest: "/etc/nginx.files/styles.css"
        mode: '0644'

    - name: Check if nginx service exists
      command: docker service ls --filter name=nginx -q
      register: nginx_service_check
      failed_when: false
      changed_when: false
      when: "'docker_swarm_manager' in group_names"

    - name: Create nginx service in Docker Swarm
      command: >
        docker service create 
        --name nginx 
        --mode global 
        --publish published=80,target=80
        --publish published=443,target=443 
        --mount type=bind,src=/etc/nginx.files/index.html,dst=/usr/share/nginx/html/index.html,readonly 
        --mount type=bind,src=/etc/nginx.files/styles.css,dst=/usr/share/nginx/html/styles.css,readonly
        nginx:latest
      when: "'docker_swarm_manager' in group_names and not nginx_service_check.stdout"
